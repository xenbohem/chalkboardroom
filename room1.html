<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Punk Vision Board</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: 'Press Start 2P', monospace;
}

.hidden { display:none; }

/* AUTH */
#auth {
  height: 100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.auth-box {
  border: 3px solid #ff00ff;
  padding: 30px;
  background:#000;
  box-shadow: 0 0 20px #00ffff;
  text-align:center;
}

.auth-box input {
  width: 90%;
  margin: 8px 0;
  padding: 10px;
  background:#111;
  color:#0ff;
  border:2px solid #ff0;
  font-family:inherit;
}

.auth-box button {
  margin-top:10px;
  padding:10px 20px;
  background:#ff0;
  border:none;
  cursor:pointer;
}

/* BOARD */
#board {
  padding:20px;
}

header {
  display:flex;
  align-items:center;
  gap:15px;
  margin-bottom:20px;
}

header img {
  width:60px;
  height:60px;
  border-radius:50%;
  border:3px solid #ff0;
  object-fit:cover;
}

#notes {
  display:flex;
  flex-wrap:wrap;
  gap:15px;
}

.note {
  width:140px;
  min-height:110px;
  padding:10px;
  background:#ffeb3b;
  color:#000;
  transform: rotate(var(--r));
  box-shadow:5px 5px 0 #000;
  font-size:0.6em;
}

textarea {
  width:100%;
  margin-top:15px;
  padding:10px;
  background:#111;
  color:#fff;
  border:2px dashed #0ff;
  font-family:inherit;
}

</style>
</head>
<body>

<!-- AUTH -->
<div id="auth">
  <div class="auth-box">
    <h2>PUNK ZEN</h2>
    <input id="username" placeholder="username (signup only)">
    <input id="email" placeholder="email">
    <input id="password" type="password" placeholder="password">
    <button onclick="signup()">SIGN UP</button>
    <button onclick="login()">LOG IN</button>
  </div>
</div>

<!-- BOARD -->
<div id="board" class="hidden">
  <header>
    <img id="avatar">
    <div>
      <div id="welcome"></div>
      <input type="file" onchange="uploadAvatar(event)">
    </div>
  </header>

  <div id="notes"></div>

  <textarea id="noteInput" placeholder="Leave your mark..."></textarea>
  <button onclick="postNote()">POST NOTE</button>
</div>

<script>
const supabase = supabasejs.createClient(
  'https://hwymepujsvfqjkbullaf.supabase.co',
  'YOUR_PUBLIC_ANON_KEY'
);

let user = null;

/* AUTH */
async function signup() {
  const email = emailInput().value;
  const password = passwordInput().value;
  const username = usernameInput().value;

  const { error } = await supabase.auth.signUp({
    email, password,
    options: { data: { username } }
  });

  if (error) alert(error.message);
  else alert('Check your email.');
}

async function login() {
  const { data, error } = await supabase.auth.signInWithPassword({
    email: emailInput().value,
    password: passwordInput().value
  });

  if (error) alert(error.message);
  else init(data.user);
}

/* SESSION */
supabase.auth.onAuthStateChange((_, session) => {
  if (session?.user) init(session.user);
});

async function init(u) {
  user = u;
  document.getElementById('auth').classList.add('hidden');
  document.getElementById('board').classList.remove('hidden');

  document.getElementById('welcome').innerText =
    `welcome ${user.user_metadata.username}`;

  loadProfile();
  loadNotes();
}

/* PROFILE */
async function loadProfile() {
  const { data } = await supabase
    .from('profiles')
    .select('avatar_url')
    .eq('id', user.id)
    .single();

  document.getElementById('avatar').src =
    data?.avatar_url || 'https://placehold.co/100x100';
}

async function uploadAvatar(e) {
  const file = e.target.files[0];
  const path = `${user.id}.png`;

  await supabase.storage.from('avatars').upload(path, file, {
    upsert:true
  });

  const url = supabase.storage.from('avatars')
    .getPublicUrl(path).data.publicUrl;

  await supabase.from('profiles').upsert({
    id:user.id,
    avatar_url:url
  });

  loadProfile();
}

/* NOTES */
async function loadNotes() {
  const { data } = await supabase
    .from('chalkboard_notes')
    .select('*')
    .order('created_at', { ascending:false });

  const board = document.getElementById('notes');
  board.innerHTML = '';

  data.forEach(n => {
    const d = document.createElement('div');
    d.className = 'note';
    d.style.setProperty('--r', `${n.rotation}deg`);
    d.innerHTML = `<strong>${n.username}</strong><br>${n.message}`;
    board.appendChild(d);
  });
}

async function postNote() {
  const msg = noteInput().value.trim();
  if (!msg) return;

  await supabase.from('chalkboard_notes').insert({
    user_id:user.id,
    username:user.user_metadata.username,
    message:msg,
    rotation:Math.random()*10-5
  });

  noteInput().value='';
  loadNotes();
}

/* HELPERS */
const emailInput = () => document.getElementById('email');
const passwordInput = () => document.getElementById('password');
const usernameInput = () => document.getElementById('username');
const noteInput = () => document.getElementById('noteInput');
</script>

</body>
</html>

